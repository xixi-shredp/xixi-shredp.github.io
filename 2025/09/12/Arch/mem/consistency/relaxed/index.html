<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Relaxed(Weaker) Memory Consistency Model | xixi's blog</title><meta name="author" content="xixi"><meta name="copyright" content="xixi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="Relaxed(Weaker) Memory Consistency Model 松散内存模型简介">
<meta property="og:type" content="article">
<meta property="og:title" content="Relaxed(Weaker) Memory Consistency Model">
<meta property="og:url" content="https://xixi-shredp.github.io/2025/09/12/Arch/mem/consistency/relaxed/index.html">
<meta property="og:site_name" content="xixi&#39;s blog">
<meta property="og:description" content="Relaxed(Weaker) Memory Consistency Model 松散内存模型简介">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xixi-shredp.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2025-09-12T12:01:45.000Z">
<meta property="article:modified_time" content="2026-02-19T14:17:40.252Z">
<meta property="article:author" content="xixi">
<meta property="article:tag" content="CPU, Computer Architechture, OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xixi-shredp.github.io/img/avatar.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Relaxed(Weaker) Memory Consistency Model",
  "url": "https://xixi-shredp.github.io/2025/09/12/Arch/mem/consistency/relaxed/",
  "image": "https://xixi-shredp.github.io/img/avatar.jpg",
  "datePublished": "2025-09-12T12:01:45.000Z",
  "dateModified": "2026-02-19T14:17:40.252Z",
  "author": [
    {
      "@type": "Person",
      "name": "xixi",
      "url": "https://xixi-shredp.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.svg"><link rel="canonical" href="https://xixi-shredp.github.io/2025/09/12/Arch/mem/consistency/relaxed/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.5.4"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.13.0/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Relaxed(Weaker) Memory Consistency Model',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 8.1.1"></head><body><div class="bg-animation" id="web_bg" style="background-image: url(/img/default_top.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/default_top.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/favicon.svg" alt="Logo"><span class="site-name">xixi's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Relaxed(Weaker) Memory Consistency Model</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Relaxed(Weaker) Memory Consistency Model</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-09-12T12:01:45.000Z" title="Created 2025-09-12 20:01:45">2025-09-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2026-02-19T14:17:40.252Z" title="Updated 2026-02-19 22:17:40">2026-02-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Arch/">Arch</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Arch/mem/">mem</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Arch/mem/consistency/">consistency</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p><strong>首次提出</strong>:<br>M. Dubois, C. Scheurich, and F. A. Briggs. Memory access buffering in multiprocessors. In Proc. of the 13th Annual International Symposium on Computer Architecture, pp. 434–42, June 1986. DOI: 10.1145&#x2F;285930.285991. 81</p>
<p><strong>1990s综述</strong>:<br>S. V. Adve and K. Gharachorloo. Shared memory consistency models: A tutorial. IEEE Computer, 29(12):66–76, December 1996. DOI: 10.1109&#x2F;2.546611. 81</p>
<p><strong>正确性证明</strong><br>A. Meixner and D. J. Sorin. Dynamic verification of memory consistency in cachecoherent multithreaded computer architectures. In Proc. of the International Conference on Dependable Systems and Networks, pp. 73–82, June 2006. DOI: 10.1109&#x2F;dsn.2006.29. 81</p>
</blockquote>
<p>提出的动机：优化性能<br>如果一些访存操作的顺序不影响最后程序执行结果的正确性，可以允许这些访存操作之间重排序以获得更高的性能</p>
<ol>
<li>Non-FIFO, 写合并的 write buffer<ul>
<li>违反了 TSO</li>
<li>要求 store 之间不能有 FENCE</li>
</ul>
</li>
<li>预测执行的实现更简单<ul>
<li>预测乱序执行时不需要检查预测指令最终的正确性 (由程序员保证)</li>
</ul>
</li>
</ol>
<p>relaxed memory models:  </p>
<ol>
<li><a href="#xc">eXample relaxed Consistency model (XC)</a></li>
<li><a href="#rc">Release Consistency (RC)</a></li>
<li><a href="#rvwmo">RISC-V Weak Memory Order (RVWMO)</a></li>
<li><a href="#ibm_power">IBM Power Memory Model</a></li>
<li>Alpha<ul>
<li>类似 XC</li>
<li>R. L. Sites, Ed. Alpha Architecture Reference Manual. Digital Press, 1992. 58, 81</li>
</ul>
</li>
<li>SPARC Relaxed Memory Order (RMO)<ul>
<li>类似 XC ，支持 TSO, PSO, RMO ，大部分实现使用 TSO</li>
<li>D. L. Weaver and T. Germond, Eds. SPARC Architecture Manual (Version 9). PTR Prentice Hall, 1994. 58, 81, 82</li>
</ul>
</li>
<li>ARM<ul>
<li>ARM v7 类似 IBM Power</li>
<li>ARM. ARM Architecture Reference Manual, ARMv7-A and ARMv7-R Edition Errata Markup. Downloaded January 13, 2011. 81, 82</li>
<li>ARM. ARM v7A+R Architectural Reference Manual. Available from ARM Ltd.</li>
<li>ARM v8 类似 RVWMO</li>
<li>ARM. ARM v8 Architectural Reference Manual. Available from ARM Ltd</li>
</ul>
</li>
</ol>
<h1 id="eXample-relaxed-Consistency-model-XC"><a href="#eXample-relaxed-Consistency-model-XC" class="headerlink" title="eXample relaxed Consistency model (XC)"></a>eXample relaxed Consistency model (XC)</h1><p><a id="xc"></a></p>
<ul>
<li>使用 FENCE 指令来定序，默认情况下 load&#x2F;store 都是不定序指令</li>
<li>FENCE 只作用于当前的核，不会影响其他核的访存顺序</li>
</ul>
<p>XC execution 的要求:  </p>
<ol>
<li>所有核将自己的 load, store, Fence 插入 global order &lt;m 的时候需满足:<ul>
<li>if L(a) &lt;p FENCE &#x3D;&gt; L(a) &lt;m FENCE</li>
<li>if S(a) &lt;p FENCE &#x3D;&gt; S(a) &lt;m FENCE</li>
<li>if FENCE &lt;p FENCE &#x3D;&gt; FENCE &lt;m FENCE</li>
<li>if FENCE &lt;p L(a) &#x3D;&gt; FENCE &lt;m L(a)</li>
<li>if FENCE &lt;p S(a) &#x3D;&gt; FENCE &lt;m S(a)</li>
</ul>
</li>
<li>所有核将自己的地址相同的 load, store 插入 global order &lt;m 的时候需满足:<ul>
<li>if L(a) &lt;p L’(a) &#x3D;&gt; L(a) &lt;m L’(a)</li>
<li>if S(a) &lt;p S(a) &#x3D;&gt; S(a) &lt;m S(a)</li>
<li>if S(a) &lt;p S’(a) &#x3D;&gt; S(a) &lt;m S’(a)</li>
</ul>
</li>
<li>每次 load 拿到的值是该 load 之前的相同地址的最后一次 store 的值<ul>
<li>Value of L(a) &#x3D; Value of $MAX_{&lt;m} {S(a) | S(a) &lt;m L(a) or S(a) &lt;p L(a) }$</li>
</ul>
</li>
</ol>
<p>XC ordering rules (X 表示强制定序, B 表示需要 bypass, A 表示地址相同时需要定序)  </p>
<table>
	<tr align="center">
	    <td colspan="6">Operation 2</td>
	</tr>
	<tr>
	    <td rowspan="5">Operation 1</td>
	    <td></td>
	    <td>Load</td>
	    <td>Store</td>
	    <td>RMW</td>
	    <td>FENCE</td>
	</tr>
	<tr>
	    <td>Load</td>
	    <td>A</td>
	    <td>A</td>
	    <td>A</td>
	    <td>X</td>
	</tr>
	<tr>
	    <td>Store</td>
	    <td>B</td>
	    <td>A</td>
	    <td>A</td>
	    <td>X</td>
	</tr>
	<tr>
	    <td>RWM</td>
	    <td>A</td>
	    <td>A</td>
	    <td>A</td>
	    <td>X</td>
	</tr>
	<tr>
	    <td>FENCE</td>
	    <td>X</td>
	    <td>X</td>
	    <td>X</td>
	    <td>X</td>
	</tr>
</table>


<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="System"><a href="#System" class="headerlink" title="System"></a>System</h3><p>The Switch<br><img src="/images/Arch/mem/consistency/relaxed/xc_switch.svg" alt="xc_switch"></p>
<p>cache-coherence system<br><img src="/images/Arch/mem/consistency/relaxed/xc_basic_impl.svg" alt="xc_basic_impl"></p>
<h3 id="原子指令"><a href="#原子指令" class="headerlink" title="原子指令"></a>原子指令</h3><p>简易实现  </p>
<ol>
<li>执行原子指令前排空 write buffer</li>
<li>获取相应 block 的读写 coherence 状态</li>
<li>执行 load 和 store ，在二者的执行之间 cache 将该 block 踢出</li>
</ol>
<p>为优化性能，可以不排空 write buffer (XC 模型允许重排序)</p>
<p>因此， XC 模型下的原子指令并不能保证同步，需要在原子指令后添加 FENCE 指令实现同步。</p>
<h3 id="FENCE"><a href="#FENCE" class="headerlink" title="FENCE"></a>FENCE</h3><p>3种实现:  </p>
<ol>
<li>nop</li>
<li>draining: 等待所有前序访存指令完成， Xi -&gt; FENCE -&gt;Yi</li>
<li>without draining: 满足 Xi -&gt; FENCE -&gt;Yi 的前提下不去排空前序访存指令</li>
</ol>
<h2 id="同步原语"><a href="#同步原语" class="headerlink" title="同步原语"></a>同步原语</h2><p>锁的实现需要在每次获取锁或者释放锁的前后都加上 FENCE 指令</p>
<h1 id="Release-Consistency-RC"><a href="#Release-Consistency-RC" class="headerlink" title="Release Consistency (RC)"></a>Release Consistency (RC)</h1><p><a id="rc"></a></p>
<blockquote>
<p>K. Gharachorloo, D. Lenoski, J. Laudon, P. Gibbons, A. Gupta, and J. Hennessy. Memory consistency and event ordering in scalable shared-memory. In Proc. of the 17th Annual International Symposium on Computer Architecture, pp. 15–26, May 1990. DOI: 10.1109&#x2F;isca.1990.134503. 72, 81</p>
</blockquote>
<p>相比于 XC, RC 认为每个同步操作都被 FENCE 包围过于浪费性能</p>
<p>因此提供了 ACQUIER 和 RELEASE 的同步原语用于获取和释放锁 (相比于 XC 的 FENCE 会排序其前后两个方向的访存操作, ACQUIRE 和 RELEASE 只会排序某一个方向的访存指令)</p>
<p>RC rules:  </p>
<ol>
<li>ACQUIRE -&gt; Load, Store (but not Load, Store -&gt; ACQUIRE) </li>
<li>Load, Store -&gt; RELEASE (but not RELEASE -&gt; Load, Store) </li>
<li>SC ordering of ACQUIREs and RELEASEs:<ul>
<li>ACQUIRE -&gt; ACQUIRE </li>
<li>ACQUIRE -&gt; RELEASE </li>
<li>RELEASE -&gt; ACQUIRE </li>
<li>RELEASE -&gt; RELEASE</li>
</ul>
</li>
</ol>
<blockquote>
<p>relaxed models 属性  </p>
<ol>
<li>causality 因果</li>
<li>write atomicity &#x2F; store atomicity &#x2F; multi-copy atomicity 写原子性<ul>
<li>一个核的 store 可以被所有其他核一次看到</li>
<li>必要不充分条件: 正确处理 Independent Read Independent Write (IRIW)</li>
<li>隐含了 causality 因果性</li>
</ul>
</li>
</ol>
</blockquote>
<h1 id="RISC-V-Weak-Memory-Order-RVWMO"><a href="#RISC-V-Weak-Memory-Order-RVWMO" class="headerlink" title="RISC-V Weak Memory Order (RVWMO)"></a>RISC-V Weak Memory Order (RVWMO)</h1><p><a id="rvwmo"></a></p>
<p>融合了 XC 和 RC:  </p>
<ol>
<li>定义了 global memory order ，存在多条 FENCE 指令变体</li>
<li>load &#x2F; store 可以带 RELEASE&#x2F;ACQUIRE 标记</li>
</ol>
<h2 id="RELEASE-ACQUIRE-orderings"><a href="#RELEASE-ACQUIRE-orderings" class="headerlink" title="RELEASE&#x2F;ACQUIRE orderings"></a>RELEASE&#x2F;ACQUIRE orderings</h2><ul>
<li>ACQUIRE 标记: $ACQUIRE-RC_{PC}$ , $ACQUIRE-RC_{SC}$</li>
<li>RELEASE 标记: $RELEASE-RC_{PC}$ , $RELEASE-RC_{SC}$</li>
</ul>
<p>load&#x2F;store 可以带任意的标记， RMW 指令只能带 $RC_{SC}$ 标记</p>
<p>ordering  </p>
<ol>
<li>ACQUIRE -&gt; Load,Store</li>
<li>Load,Store -&gt; RELEASE</li>
<li>$RELEASE-RC_{SC}$ -&gt; $ACQUIRE-RC_{SC}$</li>
</ol>
<h2 id="FENCE-orderings"><a href="#FENCE-orderings" class="headerlink" title="FENCE orderings"></a>FENCE orderings</h2><p>FENCE 指令  </p>
<ol>
<li>FENCE RW,RW <ul>
<li>load, store -&gt; load, store</li>
</ul>
</li>
<li>FENCE RW,W<ul>
<li>load, store -&gt; store</li>
</ul>
</li>
<li>FENCE R,RW<ul>
<li>load -&gt; load, store</li>
</ul>
</li>
<li>FENCE R,R<ul>
<li>load -&gt; load</li>
</ul>
</li>
<li>FENCE W,W<ul>
<li>store -&gt; store</li>
</ul>
</li>
<li>FENCE.TSO<ul>
<li>load -&gt; load, store</li>
<li>store -&gt; store</li>
</ul>
</li>
</ol>
<h2 id="Dependency-induced-orderings"><a href="#Dependency-induced-orderings" class="headerlink" title="Dependency-induced orderings"></a>Dependency-induced orderings</h2><p>对于存在数据依赖&#x2F;地址依赖的访存指令， RVWMO 会隐式地强制定序</p>
<h2 id="Same-address-orderings"><a href="#Same-address-orderings" class="headerlink" title="Same address orderings"></a>Same address orderings</h2><p>对于相同地址的访存指令， RVWMO 规定了：  </p>
<ol>
<li>Load -&gt; Store</li>
<li>Store -&gt; Store</li>
<li>部分情况下的 Load -&gt; Load<ul>
<li>相同地址的两条 load 之间没有对同一地址的 store</li>
<li>两条 load 返回的值来自于不同的 store</li>
</ul>
</li>
</ol>
<h2 id="RWM"><a href="#RWM" class="headerlink" title="RWM"></a>RWM</h2><p>RISC-V 支持 2 种 RMW 指令：  </p>
<ol>
<li>Atomic Memory Operations (AMO)</li>
<li>Load Reserved&#x2F;Store Conditionals (LdR&#x2F;StC) (成对使用)<ol>
<li>LdR 将取出值之后保留</li>
<li>StC 在保留值依然有效时才可成功执行</li>
</ol>
</li>
</ol>
<h1 id="IBM-Power-Memory-Model"><a href="#IBM-Power-Memory-Model" class="headerlink" title="IBM Power Memory Model"></a>IBM Power Memory Model</h1><p><a id="ibm_power"></a></p>
<blockquote>
<p>IBM. Power ISA Version 2.06 Revision B. <a target="_blank" rel="noopener" href="http://www.power.org/resources/">http://www.power.org/resources/</a> downloads&#x2F; PowerISA_V2.06B_V2_PUBLIC.pdf, July 2010. 78, 81</p>
</blockquote>
<p><a id="cumulative">cumulative:</a><br>定义 FENCE 之前的所有访存操作为集合 X, 之后的所有访存操作为集合 Y</p>
<ol>
<li>将其他核排在 FENCE 之前的操作加入集合 X</li>
<li>将其他核排在 FENCE 之后的操作加入集合 Y (可能是由于数据依赖、控制依赖或其他 FENCE )</li>
<li>递归地执行前两项</li>
</ol>
<p>Power model  </p>
<ol>
<li>store 相对与其他核而言，而非内存，所以不保证 total memory order<ul>
<li>一个核需要使用 FENCE 对 store 定序之后，其他核才可以看到相同的 store 顺序</li>
</ul>
</li>
<li>部分 FENCE 具有累积效果 &lt;<cumulative>&gt;</li>
<li>有 3 种 FENCE:<ul>
<li>SYNC or HWSYNC (cumulative): 将 X 的所有操作排到 Y 前</li>
<li>LWSYNC (cumulative)<ul>
<li>loads in X -&gt; loads in Y</li>
<li>loads in X -&gt; stores in Y</li>
<li>stores in X -&gt; stores in Y</li>
</ul>
</li>
<li>ISYNC (not cumulative): 用于排序两条来自同一核的 load 指令</li>
</ul>
</li>
<li>某些情况尽管没有 FENCE 依旧会排序<ul>
<li>如：前序 load 计算后序访存指令的地址，此时会隐式排序</li>
</ul>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://xixi-shredp.github.io">xixi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://xixi-shredp.github.io/2025/09/12/Arch/mem/consistency/relaxed/">https://xixi-shredp.github.io/2025/09/12/Arch/mem/consistency/relaxed/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,x,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.6/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/14/Arch/cache/replacement/coarse/recency-based/" title="Recency-Based Cache Replacement Policies"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Recency-Based Cache Replacement Policies</div></div><div class="info-2"><div class="info-item-1">基于 recency 的粗粒度 cache 替换策略简介</div></div></div></a><a class="pagination-related" href="/2025/09/12/Arch/mem/consistency/TSO/" title="Total Store Order (TSO)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Total Store Order (TSO)</div></div><div class="info-2"><div class="info-item-1">Total Store Order (TSO) 内存模型简介</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">xixi</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">52</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">32</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xixi-shredp"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/xixi-shredp" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my blog, for learning and communication purposes only. If there is any copyright infringement, please leave a message via email on GitHub.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#eXample-relaxed-Consistency-model-XC"><span class="toc-number">1.</span> <span class="toc-text">eXample relaxed Consistency model (XC)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#System"><span class="toc-number">1.1.1.</span> <span class="toc-text">System</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="toc-number">1.1.2.</span> <span class="toc-text">原子指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FENCE"><span class="toc-number">1.1.3.</span> <span class="toc-text">FENCE</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E5%8E%9F%E8%AF%AD"><span class="toc-number">1.2.</span> <span class="toc-text">同步原语</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Release-Consistency-RC"><span class="toc-number">2.</span> <span class="toc-text">Release Consistency (RC)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RISC-V-Weak-Memory-Order-RVWMO"><span class="toc-number">3.</span> <span class="toc-text">RISC-V Weak Memory Order (RVWMO)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RELEASE-ACQUIRE-orderings"><span class="toc-number">3.1.</span> <span class="toc-text">RELEASE&#x2F;ACQUIRE orderings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FENCE-orderings"><span class="toc-number">3.2.</span> <span class="toc-text">FENCE orderings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dependency-induced-orderings"><span class="toc-number">3.3.</span> <span class="toc-text">Dependency-induced orderings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Same-address-orderings"><span class="toc-number">3.4.</span> <span class="toc-text">Same address orderings</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RWM"><span class="toc-number">3.5.</span> <span class="toc-text">RWM</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#IBM-Power-Memory-Model"><span class="toc-number">4.</span> <span class="toc-text">IBM Power Memory Model</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/22/Arch/cache/prefetch/inst-pf/overview/" title="ICache Prefetcher">ICache Prefetcher</a><time datetime="2026-02-22T09:37:20.000Z" title="Created 2026-02-22 17:37:20">2026-02-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/20/Arch/cache/prefetch/data-pf/addr-correlated/" title="Address-Correlating Prefetchers">Address-Correlating Prefetchers</a><time datetime="2026-02-20T04:58:57.000Z" title="Created 2026-02-20 12:58:57">2026-02-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/20/Arch/cache/prefetch/data-pf/stride/" title="Stride/Stream Data Cache Prefetcher">Stride/Stream Data Cache Prefetcher</a><time datetime="2026-02-20T03:01:32.000Z" title="Created 2026-02-20 11:01:32">2026-02-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/12/Arch/simulator/gem5/iew/" title="Gem5: Dispatch">Gem5: Dispatch</a><time datetime="2026-02-12T09:49:07.000Z" title="Created 2026-02-12 17:49:07">2026-02-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2026/02/11/Arch/simulator/gem5/prefetch/" title="Gem5 Prefetcher">Gem5 Prefetcher</a><time datetime="2026-02-11T15:56:47.000Z" title="Created 2026-02-11 23:56:47">2026-02-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: linear-gradient(160deg, #4D063C, #3E064D, #23064D, #08064D);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 - 2026 By xixi</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></span></div><div class="footer_custom_text">Life is so Beautify!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.5.4"></script><script src="/js/main.js?v=5.5.4"></script><div class="js-pjax"><script>(() => {
  const parseViewBox = viewBox => {
    if (!viewBox) return null
    const parts = viewBox.trim().split(/[\s,]+/).map(n => Number(n))
    if (parts.length !== 4 || parts.some(n => Number.isNaN(n))) return null
    return parts
  }

  const getSvgViewBox = svg => {
    const attr = parseViewBox(svg.getAttribute('viewBox'))
    if (attr) return attr

    // Fallback: use bbox to build a viewBox
    try {
      const bbox = svg.getBBox()
      if (bbox && bbox.width && bbox.height) return [bbox.x, bbox.y, bbox.width, bbox.height]
    } catch (e) {
      // getBBox may fail on some edge cases; ignore
    }

    const w = Number(svg.getAttribute('width')) || 0
    const h = Number(svg.getAttribute('height')) || 0
    if (w > 0 && h > 0) return [0, 0, w, h]
    return [0, 0, 100, 100]
  }

  const setSvgViewBox = (svg, vb) => {
    svg.setAttribute('viewBox', `${vb[0]} ${vb[1]} ${vb[2]} ${vb[3]}`)
  }

  const clamp = (v, min, max) => Math.max(min, Math.min(max, v))

  const openSvgInNewTab = ({ source, initViewBox }) => {
    const getClonedSvg = () => {
      if (typeof source === 'string') {
        const template = document.createElement('template')
        template.innerHTML = source.trim()
        const svg = template.content.querySelector('svg')
        return svg ? svg.cloneNode(true) : null
      }
      if (source && typeof source.cloneNode === 'function') {
        return source.cloneNode(true)
      }
      return null
    }

    const clone = getClonedSvg()
    if (!clone) return
    if (initViewBox && initViewBox.length === 4) {
      clone.setAttribute('viewBox', initViewBox.join(' '))
    }
    if (!clone.getAttribute('xmlns')) clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg')
    if (!clone.getAttribute('xmlns:xlink') && clone.outerHTML.includes('xlink:')) {
      clone.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink')
    }
    // inject background to match current theme
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark'
    const bg = getComputedStyle(document.body).backgroundColor || (isDark ? '#1e1e1e' : '#ffffff')
    if (!clone.style.background) clone.style.background = bg

    const serializer = new XMLSerializer()
    const svgSource = serializer.serializeToString(clone)
    const htmlSource = `<!doctype html><html><head><meta charset="utf-8" />
      <style>
        html, body { width: 100%; height: 100%; margin: 0; display: flex; align-items: center; justify-content: center; background: ${bg}; }
        svg { max-width: 100%; max-height: 100%; height: auto; width: auto; }
      </style>
      </head><body>${svgSource}</body></html>`
    const blob = new Blob([htmlSource], { type: 'text/html;charset=utf-8' })
    const url = URL.createObjectURL(blob)
    window.open(url, '_blank', 'noopener')
    setTimeout(() => URL.revokeObjectURL(url), 30000)
  }

  const attachMermaidViewerButton = wrap => {
    let btn = wrap.querySelector('.mermaid-open-btn')
    if (!btn) {
      btn = document.createElement('button')
      btn.type = 'button'
      btn.className = 'mermaid-open-btn'
      wrap.appendChild(btn)
    }

    btn.innerHTML = '<i class="fa fa-search fa-fw" aria-hidden="true"></i>'

    if (!btn.__mermaidViewerBound) {
      btn.addEventListener('click', e => {
        e.preventDefault()
        e.stopPropagation()
        const svg = wrap.__mermaidOriginalSvg || wrap.querySelector('svg')
        if (!svg) return
        const initViewBox = wrap.__mermaidInitViewBox
        if (typeof svg === 'string') {
          openSvgInNewTab({ source: svg, initViewBox })
          return
        }
        openSvgInNewTab({ source: svg, initViewBox })
      })
      btn.__mermaidViewerBound = true
    }
  }

  // Zoom around a point (px, py) in the SVG viewport (in viewBox coordinates)
  const zoomAtPoint = (vb, factor, px, py) => {
    const w = vb[2] * factor
    const h = vb[3] * factor
    const nx = px - (px - vb[0]) * factor
    const ny = py - (py - vb[1]) * factor
    return [nx, ny, w, h]
  }

  const initMermaidGestures = wrap => {
    const svg = wrap.querySelector('svg')
    if (!svg) return

    // Ensure viewBox exists so gestures always work
    const initVb = getSvgViewBox(svg)
    wrap.__mermaidInitViewBox = initVb
    wrap.__mermaidCurViewBox = initVb.slice()
    setSvgViewBox(svg, initVb)

    // Avoid binding multiple times on themeChange/pjax
    if (wrap.__mermaidGestureBound) return
    wrap.__mermaidGestureBound = true

    // Helper: map client (viewport) coordinate -> viewBox coordinate
    const clientToViewBox = (clientX, clientY) => {
      const rect = svg.getBoundingClientRect()
      const vb = wrap.__mermaidCurViewBox || getSvgViewBox(svg)
      const x = vb[0] + (clientX - rect.left) * (vb[2] / rect.width)
      const y = vb[1] + (clientY - rect.top) * (vb[3] / rect.height)
      return { x, y, rect, vb }
    }

    const state = {
      pointers: new Map(),
      startVb: null,
      startDist: 0,
      startCenter: null
    }

    const clampVb = vb => {
      const init = wrap.__mermaidInitViewBox || vb
      const minW = init[2] * 0.1
      const maxW = init[2] * 10
      const minH = init[3] * 0.1
      const maxH = init[3] * 10
      vb[2] = clamp(vb[2], minW, maxW)
      vb[3] = clamp(vb[3], minH, maxH)
      return vb
    }

    const setCurVb = vb => {
      vb = clampVb(vb)
      wrap.__mermaidCurViewBox = vb
      setSvgViewBox(svg, vb)
    }

    const onPointerDown = e => {
      // Allow only primary button for mouse
      if (e.pointerType === 'mouse' && e.button !== 0) return
      svg.setPointerCapture(e.pointerId)
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      if (state.pointers.size === 1) {
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      } else if (state.pointers.size === 2) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        state.startDist = Math.hypot(dx, dy)
        state.startVb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        state.startCenter = { x: (pts[0].x + pts[1].x) / 2, y: (pts[0].y + pts[1].y) / 2 }
      }
    }

    const onPointerMove = e => {
      if (!state.pointers.has(e.pointerId)) return
      state.pointers.set(e.pointerId, { x: e.clientX, y: e.clientY })

      // Pan with 1 pointer
      if (state.pointers.size === 1 && state.startVb) {
        const p = [...state.pointers.values()][0]
        const prev = { x: e.clientX - e.movementX, y: e.clientY - e.movementY }
        // movementX/Y unreliable on touch, compute from stored last position
        const last = wrap.__mermaidLastSinglePointer || p
        const dxClient = p.x - last.x
        const dyClient = p.y - last.y
        wrap.__mermaidLastSinglePointer = p

        const { rect } = clientToViewBox(p.x, p.y)
        const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
        const dx = dxClient * (vb[2] / rect.width)
        const dy = dyClient * (vb[3] / rect.height)
        setCurVb([vb[0] - dx, vb[1] - dy, vb[2], vb[3]])
        return
      }

      // Pinch zoom with 2 pointers
      if (state.pointers.size === 2 && state.startVb && state.startDist > 0) {
        const pts = [...state.pointers.values()]
        const dx = pts[0].x - pts[1].x
        const dy = pts[0].y - pts[1].y
        const dist = Math.hypot(dx, dy)
        if (!dist) return
        const factor = state.startDist / dist // dist bigger => zoom in (viewBox smaller)

        const cx = (pts[0].x + pts[1].x) / 2
        const cy = (pts[0].y + pts[1].y) / 2
        const centerClient = { x: cx, y: cy }

        const pxy = clientToViewBox(centerClient.x, centerClient.y)
        const cpx = pxy.x
        const cpy = pxy.y

        const vb = zoomAtPoint(state.startVb, factor, cpx, cpy)
        setCurVb(vb)
      }
    }

    const onPointerUpOrCancel = e => {
      state.pointers.delete(e.pointerId)
      if (state.pointers.size === 0) {
        state.startVb = null
        state.startDist = 0
        state.startCenter = null
        wrap.__mermaidLastSinglePointer = null
      } else if (state.pointers.size === 1) {
        // reset single pointer baseline to avoid jump
        wrap.__mermaidLastSinglePointer = [...state.pointers.values()][0]
      }
    }

    // Wheel zoom (mouse/trackpad)
    const onWheel = e => {
      // ctrlKey on mac trackpad pinch; we treat both as zoom
      e.preventDefault()
      const delta = e.deltaY
      const zoomFactor = delta > 0 ? 1.1 : 0.9
      const { x, y } = clientToViewBox(e.clientX, e.clientY)
      const vb = (wrap.__mermaidCurViewBox || getSvgViewBox(svg)).slice()
      setCurVb(zoomAtPoint(vb, zoomFactor, x, y))
    }

    const onDblClick = () => {
      const init = wrap.__mermaidInitViewBox
      if (!init) return
      wrap.__mermaidCurViewBox = init.slice()
      setSvgViewBox(svg, init)
    }

    svg.addEventListener('pointerdown', onPointerDown)
    svg.addEventListener('pointermove', onPointerMove)
    svg.addEventListener('pointerup', onPointerUpOrCancel)
    svg.addEventListener('pointercancel', onPointerUpOrCancel)
    svg.addEventListener('wheel', onWheel, { passive: false })
    svg.addEventListener('dblclick', onDblClick)
  }

  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild

      // Clear old render (themeChange/pjax will rerun)
      const oldSvg = item.querySelector('svg')
      if (oldSvg) oldSvg.remove()
      item.__mermaidGestureBound = false

      const config = mermaidSrc.dataset.config ? JSON.parse(mermaidSrc.dataset.config) : {}
      if (!config.theme) {
        config.theme = theme
      }
      const mermaidThemeConfig = `%%{init: ${JSON.stringify(config)}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
        if (true) initMermaidGestures(item)
        item.__mermaidOriginalSvg = svg
        if (true) attachMermaidViewerButton(item)
      }


      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>